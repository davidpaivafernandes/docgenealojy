<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>DocGenealogy</title>
        <meta charset="UTF-8">
        <link rel="icon" type="image/png" href="favicon.ico">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <!-- bootstrap -->
        <link href="js/libs/bootstrap/bootstrap.min.css" rel="stylesheet" type="text/css"/>
        <link href="js/libs/bootstrap-slider/bootstrap-slider.css" rel="stylesheet" type="text/css"/>
        <script src="js/libs/bootstrap-slider/bootstrap-slider.js" type="text/javascript"></script>

        <link href="js/navbar.css" rel="stylesheet" type="text/css"/>
        <!-- jquery -->
        <link href="js/libs/jquery/jquery-ui.css" rel="stylesheet" type="text/css"/>
        <script src="js/libs/jquery/jquery.js" type="text/javascript"></script>
        <script src="js/libs/jquery/jquery-ui.js" type="text/javascript"></script>
        <!-- D3 -->
        <script src="js/libs/d3/d3.min.js" type="text/javascript"></script>
        <!-- DATA -->
        <script src="data/graph.js" type="text/javascript"></script>
        <script src="data/visited.js" type="text/javascript"></script>
        <!-- utils -->
        <script src="js/util.js" type="text/javascript"></script>
        <!-- NETWORK STYLE -->
        <style>
            .link {
                fill: none;
                stroke: #666;
                stroke-width: 1.5px;
            }

            .selectedStudents {
                fill: none;
                stroke: #f66;
                stroke-width: 3px;
            }

            #licensing {
                fill: green;
            }

            .link.licensing {
                stroke: green;
            }

            .link.resolved {
                stroke-dasharray: 0,2 1;
            }

            circle {
                fill: #ccc;
                stroke: #333;
                stroke-width: 1.5px;
            }

            text {
                font: 10px sans-serif;
                pointer-events: none;
                text-shadow: 0 1px 0 #fff, 1px 0 0 #fff, 0 -1px 0 #fff, -1px 0 0 #fff;
            }

            /* sdfsdf */

            .scaling-svg-container {
                position: relative; 
                height: 0; 
                width: 100%; 
                padding: 0;
                padding-bottom: 100%; 
                /* override this inline for aspect ratio other than square */
            }
            .scaling-svg {
                position: absolute; 
                height: 60%; 
                width: 100%; 
                /*left: 0; 
                top: 0;*/
            }

            svg {
                overflow: visible
            }

            #graphsvg {
                background-color: #dff
            }

        </style>

    </head>
    <body>

        <div class="container">

            <!-- Static navbar -->
            <nav class="navbar navbar-default">
                <div class="container-fluid">
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                            <span class="sr-only">Toggle navigation</span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a  id="start" class="action navbar-brand" href="#">DocGenealogy</a>
                    </div>
                    <div id="navbar" class="navbar-collapse collapse">
                        <ul class="nav navbar-nav">
                            <li><a id="network" class="action" href="#">Network</a></li>
                            <li><a id="almamater" class="action" href="#">Alma mater</a></li>
                            <li><a id="fields" class="action" href="#">Fields</a></li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Project<span class="caret"></span></a>
                                <ul class="dropdown-menu">
                                    <li><a id="data" href="#data" class="action">Data gathering</a></li>
                                    <li><a id="tools" href="#tools" class="action">Tools used</a></li>
                                    <!--
                                        <li role="separator" class="divider"></li>
                                        <li class="dropdown-header">Nav header</li>
                                        <li><a href="#">Separated link</a></li>
                                        <li><a href="#">One more separated link</a></li>
                                    -->
                                </ul>
                            </li>
                        </ul>

                    </div><!--/.nav-collapse -->
                </div><!--/.container-fluid -->
            </nav>

            <!-- Main component for a primary marketing message or call to action -->
            <div class="start panels" style="">
                <h1>About</h1>
                <div style="float:right;padding:15px"><img style="width:400px" src="img/graph.png" alt=""/></div>
                <p>DocGenealogy is an academic project that covers some aspects of three classes of the Master on WEB Systems and Technologies of the Universidade Aberta:

                <ul><li>Information Retrieval</li><li>HCI</li><li>Information Visualization</li></ul></p>
                <p>DocGenealogy is a kind of a Genealogy Tree of Doctoral Advisement/Mentoring relationships. The data behind this project was gathered 
                    on Wikipedia with a program implemented for that purpose.</p>
                <p>More information on the whole process can be seen on the Project menu item.</p>
                <p>We present here two types of visualization: one is a graph and the other one is a more typical histogram.</p>
                <p>Each menu option show one of the visualizations, starting with "Network" that shows the graph, followed by "Alma mater", "Fields"
                    and "Institutions", each showing an histogram of diferent dimensions of the data.</p>
            </div>

            <!-- GRAPH PANEL -->
            <div class="network panels" style="">
                <h1>Network</h1>
                <div class="container">
                    <div class="row">
                        <div class="col-md-12">
                            Start typing on one of the textboxes shows an autocompletion list of matches. Selecting one of the elements of that
                            list and pressing the ">" button, will apply the selection as a filter on the nodes of the graph.
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="ui-widget">
                                <form>
                                    <label for="autoscientists">Name: </label>
                                    <input id="autoscientists" class="form-control">
                                    <input id="goscientists" type="button" value=">" onclick="javascript:actscientists();"/>
                                </form>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="ui-widget">
                                <form>
                                    <label for="autoalmamaters">Alma mater: </label>
                                    <input id="autoalmamaters" class="form-control">
                                </form>
                                <input id="goalmamaters" type="button" value=">" onclick="javascript:actalmamater();"/>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="ui-widget">
                                <form>
                                    <label for="autofields">Fields: </label>
                                    <input id="autofields" class="form-control">
                                </form>
                                <input id="gofields" type="button" value=">" onclick="javascript:actfields();" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <br>Color by allows you to color the nodes on two diferent dimensions: age and dead/alive of the scientist.
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="colorize">Color by:</label>
                                <select class="form-control" id="colorize" onchange="javascript:changeColor(this.value);">
                                    <option value="1">None</option>
                                    <option value="2">Age</option>
                                    <option value="3">Dead/alive</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <p>
                                <label for="sdsdd">Actions:</label>
                            <p><b>Background Click and Drag => PAN</b> || Node Click and Drag => Change graph || <b>mouse wheel => Zoom In/Out</b> || Shift+Click => Node Information || <b>Dblclick => Node (un)select</b> || CTRL+Dblclick => Node cumulative (un)select</p>
                        </div>
                    </div>

                </div>
                <div class="scaling-svg-container">
                    <div id="graphcanvas">
                    </div>
                </div>
            </div>

            <!-- data -->
            <div class="data panels">
                <h1>Data</h1>
                <p>The data used in this project was gathered on Wikipedia, using a program implemented on Java that, starting on a given scientist
                    Wikipedia page will recursively get his/her Doctoral Advisors and Students, and so on.</p>
                <p>For this work we limited the number of scientists to 1000, although, starting on Alan Turings page, the program visited 3791 pages.</p>
            </div>

            <!-- TOOLS PANEL -->
            <div class="tools panels">
                <h1>Tools</h1>
                <p>This example is a quick exercise to illustrate how the default, static navbar and fixed to top navbar work. It includes the responsive CSS and HTML, so it also adapts to your viewport and device.</p>
                <ul>
                    <li>Data gathering
                        <ul>
                            <li>Java</li>
                            <li>xpath library</li>
                        </ul>
                    </li>
                    <li>Visualization
                        <ul>
                            <li><a href="https://d3js.org/">d3 Data-Driven Document</a></li>
                        </ul>
                    </li>
                </ul>
            </div>

            <!-- alma mater -->
            <div class="almamater panels">
                <h1>Alma mater</h1>
                <p>This visualization shows a static histogram of absolute frequencies of "Alma mater" institutions ordered by descendant frequency.</p>
                <div id="almamatercanvas"></div>
            </div>

            <!-- fields -->
            <div class="fields panels">
                <h1>Fields</h1>
                <p>This visualization shows a static histogram of absolute frequencies of "Fields of Study" of the scientists ordered by descendant frequency.</p>
                <div id="fieldscanvas"></div>
            </div>


            <div>
                <br><br>
                <nav class="navbar navbar-default">
                    <div class="container-fluid">
                        <div class="navbar-header">
                            <div class="row"></div>
                            <div class="col-md-6">902006 - David Fernandes</div>
                            <div class="col-md-6">david.paiva.fernandes@gmail.com</div>
                        </div>
                    </div>

                </nav>
            </div>



            <div id="dialog_scientist" style="display: inline-block"></div>

            <!-- Bootstrap core JavaScript
            ================================================== -->
            <!-- Placed at the end of the document so the pages load faster -->
            <script src="js/libs/bootstrap/bootstrap.min.js" type="text/javascript"></script>

            <script>

                                    // graph pan, zoomin and out based on an ideia by:
                                    // http://bl.ocks.org/eyaler/10586116<  

                                    var w = window.innerWidth;
                                    var h = window.innerHeight;
                                    var keyc = true, keys = true, keyt = true, keyr = true, keyx = true, keyd = true, keyl = true, keym = true, keyh = true, key1 = true, key2 = true, key3 = true, key0 = true

                                    var text_center = false;
                                    var size = d3.scale.pow().exponent(1)
                                            .domain([1, 100])
                                            .range([8, 24]);
                                    var nominal_base_node_size = 8;
                                    var nominal_text_size = 10;
                                    var max_text_size = 24;
                                    var nominal_stroke = 1.5;
                                    var max_stroke = 4.5;
                                    var max_base_node_size = 36;
                                    var min_zoom = 0.1;
                                    var max_zoom = 7;
                                    var linkedByIndex = {};

                                    links.forEach(function (d) {
                                        linkedByIndex[d.source + "," + d.target] = true;
                                    });

                                    colorFunction = function (x) {
                                        return colorAge(x);
                                    };
                                    colorValueFunction = function (x) {
                                        return 1000;
                                    };

                                    function getAge(scientist) {
                                        var b = scientist.born ? getYear(scientist.born) : 0;
                                        var d = scientist.died ? getYear(scientist.died) : 2016;
                                        return d - b;
                                    }

                                    function getAlive(scientist) {
                                        return scientist.died ? 1 : 0;
                                    }

                                    function getYear(date) {
                                        if (date && date !== "") {
                                            var y = date.split(" ");
                                            return(y[y.length - 1]);
                                        } else
                                            return 0;
                                    }

                                    var colorAge = d3.scale.linear()
                                            .domain([30, 100, 1000])
                                            .range(["red", "blue", "#bbb"]);

                                    var colorDeadAlive = d3.scale.linear()
                                            .domain([0, 1])
                                            .range(["red", "black"]);

                                    function changeColor(type) {
                                        switch (type) {
                                            case "2":
                                                colorFunction = function (x) {
                                                    return colorAge(x);
                                                };
                                                colorValueFunction = function (x) {
                                                    return getAge(x);
                                                };
                                                act();
                                                break;
                                            case "3":
                                                colorFunction = function (x) {
                                                    return colorDeadAlive(x);
                                                };
                                                colorValueFunction = function (x) {
                                                    return getAlive(x);
                                                };
                                                act();
                                                break;
                                            default:
                                                colorFunction = function (x) {
                                                    return colorAge(x);
                                                };
                                                colorValueFunction = function (x) {
                                                    return 1000;
                                                };
                                                act();
                                                break;

                                        }
                                    }

                                    function isConnected(a, b) {
                                        return linkedByIndex[a.index + "," + b.index] || linkedByIndex[b.index + "," + a.index] || a.index === b.index;
                                    }

                                    function hasConnections(a) {
                                        for (var property in linkedByIndex) {
                                            s = property.split(",");
                                            if ((s[0] == a.name || s[1] == a.name) && linkedByIndex[property])
                                                return true;
                                        }
                                        return false;
                                    }

                                    var f1 = function (x) {
                                        return true;
                                    };
                                    var f2 = function (x) {
                                        return true;
                                    };
                                    function actfields() {
                                        f1 = function (d) {

                                            if ($("#autofields").val() === "")
                                                return true;

                                            var b1 = false;
                                            for (var i = 0; i < scientists[scientistIndex[d.source.name]].fields.length; i++) {
                                                if (scientists[scientistIndex[d.source.name]].fields[i].value.toLowerCase() === $("#autofields").val().toLowerCase()) {
                                                    b1 = true;
                                                    break;
                                                }
                                            }
                                            var b2 = false;
                                            for (var i = 0; i < scientists[scientistIndex[d.target.name]].fields.length; i++) {
                                                if (scientists[scientistIndex[d.target.name]].fields[i].value.toLowerCase() === $("#autofields").val().toLowerCase()) {
                                                    b2 = true;
                                                    break;
                                                }
                                            }
                                            return b1 && b2;
                                        };
                                        f2 = function (d) {

                                            if ($("#autofields").val() === "")
                                                return true;

                                            if (hasConnections(d)) {
                                                for (var i = 0; i < scientists[scientistIndex[d.name]].fields.length; i++) {
                                                    if (scientists[scientistIndex[d.name]].fields[i].value.toLowerCase() === $("#autofields").val().toLowerCase()) {
                                                        return true;
                                                    }
                                                }
                                            }
                                            return false;
                                        };
                                        act();
                                    }

                                    function actalmamater() {
                                        f1 = function (d) {
                                            return $("#autoalmamaters").val() === "" || (scientists[scientistIndex[d.source.name]].almamater.toLowerCase() === $("#autoalmamaters").val().toLowerCase() && scientists[scientistIndex[d.target.name]].almamater.toLowerCase() === $("#autoalmamaters").val().toLowerCase());
                                        };
                                        f2 = function (d) {
                                            return $("#autoalmamaters").val() === "" || (hasConnections(d) && scientists[scientistIndex[d.name]].almamater.toLowerCase() === $("#autoalmamaters").val().toLowerCase());
                                        };
                                        act();
                                    }

                                    function actscientists() {
                                        f1 = function (d) {
                                            return true;
                                        };
                                        f2 = function (d) {
                                            if (scientists[scientistIndex[d.name]].name.toLowerCase() === $("#autoscientists").val().toLowerCase()) {
                                                d3.select("#node_" + scientistIndex[d.name]).style("fill", "#33f").style("stroke", "#00f").style("stroke-width", 3);
                                            }
                                            return true;
                                        };
                                        act();
                                    }

                                    function act() {
                                        d3.select("svg").selectAll("path").style("display", function (d) {
                                            if (d !== 'suit') {
                                                var flag = f1(d);
                                                linkedByIndex[d.idFrom + "," + d.idTo] = flag;
                                                linkedByIndex[d.idTo + "," + d.idFrom] = flag;
                                                return flag ? "inline" : "none";
                                            }
                                        });
                                        d3.select("svg").selectAll("circle").style("display", function (d) {
                                            return f2(d) ? "inline" : "none";
                                        }).style("fill", function (d, i) {
                                            return colorFunction(colorValueFunction(scientists[scientistIndex[d.name]]));
                                        });


                                        d3.select("svg").selectAll("text").style("display", function (d) {
                                            return f2(d) ? "inline" : "none";
                                        });
                                    }


                                    function buildScientistDialog(scientist) {

                                        function formatDate(date) {
                                            var d = date.split(" ");
                                            return d[2] + " " + d[1] + " " + d[5];
                                        }

                                        var html = "<div id='vcard'>" +
                                                "<div class=''>" +
                                                "<table><tr><td colspan='2'><a target='_new' href='https://en.wikipedia.org" + scientist.url + "'>Wiki page</a><br><br></td></tr>";
                                        if (scientist.photo !== "") {
                                            html += "<tr>" +
                                                    " <td colspan='2' style='text-align:center;padding-bottom:0.5em'>" +
                                                    "  <img alt='" + scientist.name + "' src='" + scientist.photo + "' data-file-width='707' data-file-height='919' />" +
                                                    " </td>" +
                                                    "</tr>";
                                        }

                                        if (scientist.born !== "") {
                                            html += "<tr>" +
                                                    " <th style='width:150px'>Born</th>" +
                                                    " <td>" + formatDate(scientist.born) + "</td>" +
                                                    "</tr>";
                                        }

                                        if (scientist.died !== "") {
                                            html += "<tr>" +
                                                    " <th scope='row'>Died</th>" +
                                                    " <td>" + formatDate(scientist.died) + "</td>" +
                                                    "</tr>";
                                        }

                                        if (scientist.nationality !== "") {
                                            html += "<tr><th scope='row'>Nationality</th>" +
                                                    " <td>" + scientist.nationality + "</td>" +
                                                    "</tr>";
                                        }

                                        if (scientist.fields.length > 0) {
                                            var fields = "";
                                            for (var i = 0; i < scientist.fields.length; i++) {
                                                if (fields !== "")
                                                    fields += ", ";
                                                fields += "<a target='_new' href='https://en.wikipedia.org" + scientist.fields[i].key + "' title='" + scientist.fields[i].value + "'>" + scientist.fields[i].value + "</a>";
                                            }
                                            fields = "<tr>" +
                                                    "  <th scope='row'>Fields</th>" +
                                                    "  <td>" + fields + "</td>" +
                                                    " </tr>";
                                            html += fields;
                                        }

                                        if (scientist.institutions.length > 0) {
                                            var institutions = "";
                                            for (var i = 0; i < scientist.institutions.length; i++) {
                                                if (institutions !== "")
                                                    institutions += ", ";
                                                institutions += "<a target='_new' href='https://en.wikipedia.org" + scientist.institutions[i].key + "' title='" + scientist.institutions[i].value + "'>" + scientist.institutions[i].value + "</a>";
                                            }
                                            institutions += "</td></tr>";
                                            html += "<tr>" +
                                                    " <th scope='row'>Institutions</th>" +
                                                    " <td>" + institutions;
                                        }

                                        if (scientist.almamater !== "") {
                                            html += "<tr>" + "<th scope='row'>Alma mater</th>" +
                                                    "<td>" + scientist.almamater + "</td>" + "</tr>";
                                        }

                                        html += "</table></div></div>";
                                        return html;
                                    }

                                    var nodes = {};
                                    var scientistIndex = [];

                                    function getInstitutions(data) {
                                        var result = [];
                                        for (var i = 0; i < data.length; i++) {
                                            for (var j = 0; j < data[i].institutions.length; j++) {
                                                var s = data[i].institutions[j].value;
                                                result.push({"institution": s});
                                            }
                                        }

                                        var institutionsCount = d3.nest()
                                                .key(function (d) {
                                                    return d.institution;
                                                })
                                                .rollup(function (v) {
                                                    return v.length;
                                                })
                                                .sortKeys(d3.ascending)
                                                .entries(result);
                                        return institutionsCount;
                                    }

                                    function getAlmaMater(data) {
                                        var result = [];
                                        for (var i in data) {
                                            if (data[i].almamater != "")
                                                result.push(data[i].almamater);
                                        }

                                        var almamaterCount = d3.nest()
                                                .key(function (d) {
                                                    return d;
                                                })
                                                .rollup(function (v) {
                                                    return v.length;
                                                })
                                                .sortKeys(d3.ascending)
                                                .entries(result);
                                        return almamaterCount;
                                    }

                                    function getFields(data) {
                                        var result = [];
                                        for (var i = 0; i < data.length; i++) {
                                            for (var j = 0; j < data[i].fields.length; j++) {
                                                var s = data[i].fields[j].value;
                                                result.push({"field": s});
                                            }
                                        }

                                        var fieldsCount = d3.nest()
                                                .key(function (d) {
                                                    return d.field;
                                                })
                                                .rollup(function (v) {
                                                    return v.length;
                                                })
                                                .sortKeys(d3.ascending)
                                                .entries(result);
                                        return fieldsCount;
                                    }

                                    // global mod keys states for whatever uses
                                    var ctrlPressed = false;
                                    var shiftPressed = false;
                                    var altPressed = false;

                                    $(document).ready(function () {

                                        // autolcomplete name
                                        var listNames = [];
                                        for (var i = 0; i < scientists.length; i++) {
                                            listNames.push(scientists[i].name);
                                        }
                                        listNames = listNames.sort().unique(true);
                                        // autolcomplete almamater
                                        var listAlmamaters = [];
                                        for (var i = 0; i < scientists.length; i++) {
                                            listAlmamaters.push(scientists[i].almamater);
                                        }
                                        listAlmamaters = listAlmamaters.sort().unique(true);
                                        // autolcomplete fields
                                        var listFields = [];
                                        for (var i = 0; i < scientists.length; i++) {
                                            for (var j = 0; j < scientists[i].fields.length; j++)
                                                listFields.push(scientists[i].fields[j].value);
                                        }
                                        listFields = listFields.sort().unique(true);
                                        var accentMap = {
                                            "รก": "a",
                                            "รถ": "o"
                                        };
                                        var normalize = function (term) {
                                            var ret = "";
                                            for (var i = 0; i < term.length; i++) {
                                                ret += accentMap[ term.charAt(i) ] || term.charAt(i);
                                            }
                                            return ret;
                                        };
                                        $("#autoscientists").autocomplete({
                                            source: function (request, response) {
                                                var matcher = new RegExp($.ui.autocomplete.escapeRegex(request.term), "i");
                                                response($.grep(listNames, function (value) {
                                                    value = value.label || value.value || value;
                                                    return matcher.test(value) || matcher.test(normalize(value));
                                                }));
                                            }
                                        });
                                        $("#autoalmamaters").autocomplete({
                                            source: function (request, response) {
                                                var matcher = new RegExp($.ui.autocomplete.escapeRegex(request.term), "i");
                                                response($.grep(listAlmamaters, function (value) {
                                                    value = value.label || value.value || value;
                                                    return matcher.test(value) || matcher.test(normalize(value));
                                                }));
                                            }
                                        });
                                        $("#autofields").autocomplete({
                                            source: function (request, response) {
                                                var matcher = new RegExp($.ui.autocomplete.escapeRegex(request.term), "i");
                                                response($.grep(listFields, function (value) {
                                                    value = value.label || value.value || value;
                                                    return matcher.test(value) || matcher.test(normalize(value));
                                                }));
                                            }
                                        });
                                        $(window).keydown(function (evt) {
                                            switch (evt.which) {
                                                case 16:
                                                    shiftPressed = true;
                                                    break;
                                                case 17:
                                                    ctrlPressed = true;
                                                    break;
                                                case 18:
                                                    altPressed = true;
                                                    break;
                                                default:
                                            }
                                        }).keyup(function (evt) {
                                            switch (evt.which) {
                                                case 16:
                                                    shiftPressed = false;
                                                    break;
                                                case 17:
                                                    ctrlPressed = false;
                                                    break;
                                                case 18:
                                                    altPressed = false;
                                                    break;
                                                default:
                                            }
                                        });

                                        var currentContent = "start";
                                        $("." + currentContent).attr("style", "display:block");
                                        $(".action").click(function (e) {
                                            var pan = e.toElement || e.relatedTarget || e.target || function () {
                                                throw "Failed to attach an event target!";
                                            };
                                            var panelId = pan.id;
                                            console.log(panelId);
                                            if (currentContent !== panelId) {
                                                $("." + currentContent).fadeOut("fast", function () {
                                                    $("." + panelId).fadeIn("fast");
                                                });
                                                currentContent = panelId;
                                            }
                                            e.preventDefault();
                                        });

                                        var minYear = 99999;
                                        var maxYear = -minYear;
                                        var minAlmaMater = 9e10;
                                        var maxAlmaMater = -minAlmaMater;

                                        buildIndexToScientists(scientists);

                                        minYear = parseInt(minYear);
                                        maxYear = parseInt(maxYear);

                                        buildNetwork(scientists);
                                        buildFields(scientists);
                                        buildInstitutions(scientists);
                                        buildAlmaMater(scientists);
                                        
                                        //act();

                                        function buildIndexToScientists(data) {
                                            for (var i in data) {
                                                scientistIndex[data[i].url] = i;
                                                var h = hash(data[i].almamater);
                                                if (h < minAlmaMater)
                                                    minAlmaMater = h;
                                                if (h > maxAlmaMater)
                                                    maxAlmaMater = h;
                                                var y = "";
                                                if (data[i].born) {
                                                    y = data[i].born;
                                                    y = y.split(" ");
                                                    y = y[y.length - 1];
                                                    if (y < minYear)
                                                        minYear = y;
                                                    if (y > maxYear)
                                                        maxYear = y;
                                                }
                                            }
                                        }

                                        function buildAlmaMater(data) {
                                            var fields = getAlmaMater(data).sort(function (a, b) {
                                                return (a.values < b.values ? 1 : -1);
                                            });
                                            hashCode = function (str) {
                                                var hash = 0;
                                                if (!str)
                                                    return hash;
                                                if (str.length == 0)
                                                    return hash;
                                                for (i = 0; i < str.length; i++) {
                                                    char = str.charCodeAt(i);
                                                    hash = ((hash << 5) - hash) + char;
                                                    hash = hash & hash; // Convert to 32bit integer
                                                }
                                                return hash;
                                            }

                                            colorfn = function (d) {
                                                return d3.hsl(hashCode(d.key) % 360, 0.5, 0.5)
                                            };
                                            var width = 960,
                                                    height = 500;
                                            xlog = d3.scale.log();
                                            xlog.domain([1, 100]);
                                            xlog.range([200, width - 20]);
                                            x = function (x) {
                                                if (x == 0) {
                                                    return 200;
                                                } else {
                                                    return 200 + xlog(x);
                                                }
                                            };
                                            var svg = d3.select("#almamatercanvas").append("svg")
                                                    .attr("width", width)
                                                    .attr("height", height)
                                                    .append("g")
                                                    .attr("transform", "translate(32, 132)");
                                            function update(data)
                                            {
                                                // TEXT

                                                var step = 15;
                                                var text = svg.selectAll("text")
                                                        .data(data, function (d) {
                                                            return d.key;
                                                        });
                                                // update
                                                text
                                                        .transition()
                                                        .duration(750)
                                                        .attr("y", function (d, i) {
                                                            return i * step;
                                                        })
                                                        .style("fill-opacity", 1);
                                                // enter
                                                text.enter().append("text")
                                                        .style("fill-opacity", 1e-6)
                                                        .style("fill", colorfn)
                                                        .attr("y", height)
                                                        .attr("x", 32)
                                                        .text(function (d) {
                                                            return d.key + " [" + d.values + "]";
                                                        })
                                                        .transition()
                                                        .duration(750)
                                                        .style("fill-opacity", 1)
                                                        .attr("y", function (d, i) {
                                                            return i * step - 13;
                                                        });
                                                // exit
                                                text.exit()
                                                        .transition()
                                                        .duration(750)
                                                        .style("fill-opacity", 1e-6)
                                                        .attr("y", height)
                                                        .remove();
                                                // LINES

                                                var line = svg.selectAll(".bar")
                                                        .data(data, function (d) {
                                                            return d.key;
                                                        });
                                                // update
                                                line
                                                        .transition()
                                                        .duration(750)
                                                        .attr("x2", function (d) {
                                                            return x(d.values);
                                                        })
                                                        .attr("y1", function (d, i) {
                                                            return i * step - 15;
                                                        })
                                                        .attr("y2", function (d, i) {
                                                            return i * step - 15;
                                                        })

                                                        .style("stroke-opacity", "1");
                                                // enter
                                                line.enter().append("line")
                                                        .attr("class", "bar")
                                                        .attr("y1", height)
                                                        .attr("y2", height)
                                                        .attr("x1", x(0))
                                                        .attr("x2", function (d) {
                                                            return x(d.values);
                                                        })
                                                        .attr("id", function (d) {
                                                            return d.key;
                                                        })
                                                        .style("stroke-width", "10")
                                                        .style("stroke", colorfn)
                                                        .style("stroke-opacity", 1e-6)
                                                        .transition()
                                                        .duration(750)
                                                        .attr("y1", function (d, i) {
                                                            return i * step - 15;
                                                        })
                                                        .attr("y2", function (d, i) {
                                                            return i * step - 15;
                                                        })
                                                        .style("stroke-opacity", 1);
                                                // exit
                                                line.exit()
                                                        .transition()
                                                        .duration(750)
                                                        .attr("y1", height)
                                                        .attr("y2", height)
                                                        .style("stroke-opacity", "0");
                                                // TICKS

                                                var tick = svg.selectAll(".tick")
                                                        .data(xlog.ticks());
                                                // enter
                                                tick.enter().append("line")
                                                        .attr("class", "tick")
                                                        .attr("x1", x)
                                                        .attr("x2", x)
                                                        .attr("y1", -100)
                                                        .attr("y2", height)
                                                        .style("stroke-width", 3)
                                                        .style("stroke", "rgb(255,255,255)");
                                            }

                                            var test = [[{word: "hello", count: 10},
                                                    {word: "world", count: 5}],
                                                [{word: "world", count: 25},
                                                    {word: "hello", count: 8}],
                                                [{word: "world", count: 6}],
                                                [{word: "hi", count: 2}]];
                                            update(fields);
                                        }

                                        function buildFields(data) {
                                            var fields = getFields(data).sort(function (a, b) {
                                                return (a.values < b.values ? 1 : -1);
                                            });
                                            hashCode = function (str) {
                                                var hash = 0;
                                                if (!str)
                                                    return hash;
                                                if (str.length == 0)
                                                    return hash;
                                                for (i = 0; i < str.length; i++) {
                                                    char = str.charCodeAt(i);
                                                    hash = ((hash << 5) - hash) + char;
                                                    hash = hash & hash; // Convert to 32bit integer
                                                }
                                                return hash;
                                            }

                                            colorfn = function (d) {
                                                return d3.hsl(hashCode(d.key) % 360, 0.5, 0.5)
                                            };
                                            var width = 960,
                                                    height = 500;
                                            xlog = d3.scale.log();
                                            xlog.domain([1, 100]);
                                            xlog.range([200, width - 20]);
                                            x = function (x) {
                                                if (x == 0) {
                                                    return 200;
                                                } else {
                                                    return 200 + xlog(x);
                                                }
                                            };
                                            var svg = d3.select("#fieldscanvas").append("svg")
                                                    .attr("width", width)
                                                    .attr("height", height)
                                                    .append("g")
                                                    .attr("transform", "translate(32, 132)");
                                            function update(data)
                                            {
                                                // TEXT

                                                var step = 15;
                                                var text = svg.selectAll("text")
                                                        .data(data, function (d) {
                                                            return d.key;
                                                        });
                                                // update
                                                text
                                                        .transition()
                                                        .duration(750)
                                                        .attr("y", function (d, i) {
                                                            return i * step;
                                                        })
                                                        .style("fill-opacity", 1);
                                                // enter
                                                text.enter().append("text")
                                                        .style("fill-opacity", 1e-6)
                                                        .style("fill", colorfn)
                                                        .attr("y", height)
                                                        .attr("x", 32)
                                                        .text(function (d) {
                                                            return d.key + " [" + d.values + "]";
                                                        })
                                                        .transition()
                                                        .duration(750)
                                                        .style("fill-opacity", 1)
                                                        .attr("y", function (d, i) {
                                                            return i * step - 13;
                                                        });
                                                // exit
                                                text.exit()
                                                        .transition()
                                                        .duration(750)
                                                        .style("fill-opacity", 1e-6)
                                                        .attr("y", height)
                                                        .remove();
                                                // LINES

                                                var line = svg.selectAll(".bar")
                                                        .data(data, function (d) {
                                                            return d.key;
                                                        });
                                                // update
                                                line
                                                        .transition()
                                                        .duration(750)
                                                        .attr("x2", function (d) {
                                                            return x(d.values);
                                                        })
                                                        .attr("y1", function (d, i) {
                                                            return i * step - 15;
                                                        })
                                                        .attr("y2", function (d, i) {
                                                            return i * step - 15;
                                                        })
                                                        .style("stroke-opacity", "1");
                                                // enter
                                                line.enter().append("line")
                                                        .attr("class", "bar")
                                                        .attr("y1", height)
                                                        .attr("y2", height)
                                                        .attr("x1", x(0))
                                                        .attr("x2", function (d) {
                                                            return x(d.values);
                                                        })
                                                        .style("stroke-width", "10")
                                                        .style("stroke", colorfn)
                                                        .style("stroke-opacity", 1e-6)
                                                        .transition()
                                                        .duration(750)
                                                        .attr("y1", function (d, i) {
                                                            return i * step - 15;
                                                        })
                                                        .attr("y2", function (d, i) {
                                                            return i * step - 15;
                                                        })
                                                        .style("stroke-opacity", 1);
                                                // exit
                                                line.exit()
                                                        .transition()
                                                        .duration(750)
                                                        .attr("y1", height)
                                                        .attr("y2", height)
                                                        .style("stroke-opacity", "0");
                                                // TICKS

                                                var tick = svg.selectAll(".tick")
                                                        .data(xlog.ticks());
                                                // enter
                                                tick.enter().append("line")
                                                        .attr("class", "tick")
                                                        .attr("x1", x)
                                                        .attr("x2", x)
                                                        .attr("y1", -100)
                                                        .attr("y2", height)
                                                        .style("stroke-width", 3)
                                                        .style("stroke", "rgb(255,255,255)");
                                            }

                                            var test = [[{word: "hello", count: 10},
                                                    {word: "world", count: 5}],
                                                [{word: "world", count: 25},
                                                    {word: "hello", count: 8}],
                                                [{word: "world", count: 6}],
                                                [{word: "hi", count: 2}]];
                                            update(fields);
                                        }

                                        function buildInstitutions(data) {

                                            var institutions = getInstitutions(data).sort(function (a, b) {
                                                return (a.values < b.values ? 1 : -1);
                                            });
                                            hashCode = function (str) {
                                                var hash = 0;
                                                if (!str)
                                                    return hash;
                                                if (str.length == 0)
                                                    return hash;
                                                for (i = 0; i < str.length; i++) {
                                                    char = str.charCodeAt(i);
                                                    hash = ((hash << 5) - hash) + char;
                                                    hash = hash & hash; // Convert to 32bit integer
                                                }
                                                return hash;
                                            }

                                            colorfn = function (d) {
                                                return d3.hsl(hashCode(d.key) % 360, 0.5, 0.5)
                                            };
                                            var width = 960,
                                                    height = 500;
                                            xlog = d3.scale.log();
                                            xlog.domain([1, 100]);
                                            xlog.range([200, width - 20]);
                                            x = function (x) {
                                                if (x == 0) {
                                                    return 200;
                                                } else {
                                                    return 200 + xlog(x);
                                                }
                                            };
                                            var svg = d3.select("#institutionscanvas").append("svg")
                                                    .attr("width", width)
                                                    .attr("height", height)
                                                    .append("g")
                                                    .attr("transform", "translate(32, 132)");
                                            function update(data)
                                            {
                                                // TEXT

                                                var step = 15;
                                                var text = svg.selectAll("text")
                                                        .data(data, function (d) {
                                                            return d.key;
                                                        });
                                                // update
                                                text
                                                        .transition()
                                                        .duration(750)
                                                        .attr("y", function (d, i) {
                                                            return i * step - 50;
                                                        })
                                                        .style("fill-opacity", 1);
                                                // enter
                                                text.enter().append("text")
                                                        .style("fill-opacity", 1e-6)
                                                        .style("fill", colorfn)
                                                        .attr("y", height)
                                                        .attr("x", 32)
                                                        .text(function (d) {
                                                            return d.key + " [" + d.values + "]";
                                                        })
                                                        .transition()
                                                        .duration(750)
                                                        .style("fill-opacity", 1)
                                                        .attr("y", function (d, i) {
                                                            return i * step - 13;
                                                        });
                                                // exit
                                                text.exit()
                                                        .transition()
                                                        .duration(750)
                                                        .style("fill-opacity", 1e-6)
                                                        .attr("y", height)
                                                        .remove();
                                                // LINES

                                                var line = svg.selectAll(".bar")
                                                        .data(data, function (d) {
                                                            return d.key;
                                                        });
                                                // update
                                                line
                                                        .transition()
                                                        .duration(750)
                                                        .attr("x2", function (d) {
                                                            return x(d.values);
                                                        })
                                                        .attr("y1", function (d, i) {
                                                            return i * step - 15;
                                                        })
                                                        .attr("y2", function (d, i) {
                                                            return i * step - 15;
                                                        })
                                                        .style("stroke-opacity", "1");
                                                // enter
                                                line.enter().append("line")
                                                        .attr("class", "bar")
                                                        .attr("y1", height)
                                                        .attr("y2", height)
                                                        .attr("x1", x(0))
                                                        .attr("x2", function (d) {
                                                            return x(d.values);
                                                        })
                                                        .style("stroke-width", "12")
                                                        .style("stroke", colorfn)
                                                        .style("stroke-opacity", 1e-6)
                                                        .transition()
                                                        .duration(750)
                                                        .attr("y1", function (d, i) {
                                                            return i * step - 15;
                                                        })
                                                        .attr("y2", function (d, i) {
                                                            return i * step - 15;
                                                        })
                                                        .style("stroke-opacity", 1);
                                                // exit
                                                line.exit()
                                                        .transition()
                                                        .duration(750)
                                                        .attr("y1", height)
                                                        .attr("y2", height)
                                                        .style("stroke-opacity", "0");
                                                // TICKS

                                                var tick = svg.selectAll(".tick")
                                                        .data(xlog.ticks());
                                                // enter
                                                tick.enter().append("line")
                                                        .attr("class", "tick")
                                                        .attr("x1", x)
                                                        .attr("x2", x)
                                                        .attr("y1", -100)
                                                        .attr("y2", height)
                                                        .style("stroke-width", 3)
                                                        .style("stroke", "rgb(255,255,255)");
                                            }

                                            var test = [[{word: "hello", count: 10},
                                                    {word: "world", count: 5}],
                                                [{word: "world", count: 25},
                                                    {word: "hello", count: 8}],
                                                [{word: "world", count: 6}],
                                                [{word: "hi", count: 2}]];
                                            update(institutions);
                                        }

                                        var iniLeft;
                                        var iniTop;
                                        function buildNetwork(data) {

                                            // Compute the distinct nodes from the links.
                                            links.forEach(function (link) {
                                                link.source = nodes[link.source] || (nodes[link.source] = {name: link.source});
                                                link.target = nodes[link.target] || (nodes[link.target] = {name: link.target});
                                                //link.type = "link suit";
                                            });
                                            var width = 960,
                                                    height = 500;
                                            var force = d3.layout.force()
                                                    .nodes(d3.values(nodes))
                                                    .links(links)
                                                    .size([width, height])
                                                    .linkDistance(60)
                                                    .charge(-300)
                                                    .on("tick", tick)
                                                    .start();
                                            var zoom = d3.behavior.zoom().scaleExtent([min_zoom, max_zoom]);
                                            var svg = d3.select("#graphcanvas").append("svg")
                                                    .attr("id", "graphsvg")
                                                    .attr("class", "scaling-svg");
                                            // Per-type markers, as they don't inherit styles.
                                            svg.append("defs").selectAll("marker")
                                                    .data(["suit"])
                                                    .enter().append("marker")
                                                    .attr("id", function (d) {
                                                        return d;
                                                    })
                                                    .attr("viewBox", "0 -5 10 10")
                                                    .attr("refX", 15)
                                                    .attr("refY", -1.5)
                                                    .attr("markerWidth", 6)
                                                    .attr("markerHeight", 6)
                                                    .attr("orient", "auto")
                                                    .append("path")
                                                    .attr("d", "M0,-5L10,0L0,5");
                                            var g = svg.append("g");
                                            var path = g.selectAll("path")
                                                    .data(force.links())
                                                    .enter().append("path")
                                                    .attr("idfrom", linkFrom)
                                                    .attr("idto", linkTo)
                                                    .attr("class", function (d) {
                                                        return "link " + d.type;
                                                    })
                                                    .attr("marker-end", function (d) {
                                                        return "url(#" + d.type + ")";
                                                    });
                                            var currentIds = [];
                                            var circle = g.selectAll("circle")
                                                    .data(force.nodes())
                                                    .enter().append("circle")
                                                    .attr("r", 6)
                                                    .attr("id", function (d) {
                                                        return "node_" + scientistIndex[d.name];
                                                    })
                                                    .style("fill", function (d, i) {
                                                        return colorFunction(colorValueFunction(scientists[scientistIndex[d.name]]));
                                                    })
                                                    // show popup with scientist information
                                                    .on("click", function () {
                                                        if (shiftPressed) {
                                                            $("#dialog_scientist").html(buildScientistDialog(data[this.id.split("_")[1]]));
                                                            $("#dialog_scientist").dialog({
                                                                title: data[this.id.split("_")[1]].name,
                                                                resizable: true,
                                                                width: 480,
                                                                modal: true
                                                            });
                                                        }
                                                    })
                                                    // select scientist, advisers and students
                                                    .on("dblclick", function () {
                                                        if (ctrlPressed) { // add to selection

                                                            // if is selected, remove from selection
                                                            if (currentIds.contains(this.id)) {
                                                                d3.select("#" + this.id).style("fill", "#ccc").style("stroke", "#333");
                                                                d3.selectAll("[idfrom='" + this.id.split("_")[1] + "']").style("stroke", "#666").style("stroke-width", "1.5");
                                                                d3.selectAll("[idto='" + this.id.split("_")[1] + "']").style("stroke", "#666").style("stroke-width", "1.5");
                                                                currentIds.remove(this.id);
                                                            } else {
                                                                // add to selection
                                                                currentIds.push(this.id);
                                                                d3.select(this)
                                                                        .style("fill", "lightcoral")
                                                                        .style("stroke", "red");
                                                                d3.selectAll("[idto='" + this.id.split("_")[1] + "']").style("stroke", "#66f").style("stroke-width", "2.5");
                                                                d3.selectAll("[idfrom='" + this.id.split("_")[1] + "']").style("stroke", "#f66").style("stroke-width", "2.5");
                                                            }
                                                        } else { // 
                                                            if (currentIds.contains(this.id)) { // remove this from selection
                                                                d3.select("#" + this.id).style("fill", "#ccc").style("stroke", "#333");
                                                                d3.selectAll("[idfrom='" + this.id.split("_")[1] + "']").style("stroke", "#666").style("stroke-width", "1.5");
                                                                d3.selectAll("[idto='" + this.id.split("_")[1] + "']").style("stroke", "#666").style("stroke-width", "1.5");
                                                                currentIds.remove(this.id);
                                                            } else {
                                                                // no ctrl, substitute selection
                                                                // revert selected IDs to normal style
                                                                for (var i = 0; i < currentIds.length; i++) {
                                                                    d3.select("#" + currentIds[i]).style("fill", "#ccc").style("stroke", "#333");
                                                                    d3.selectAll("[idfrom='" + currentIds[i].split("_")[1] + "']").style("stroke", "#666").style("stroke-width", "1.5");
                                                                    d3.selectAll("[idto='" + currentIds[i].split("_")[1] + "']").style("stroke", "#666").style("stroke-width", "1.5");
                                                                }

                                                                d3.select(this)
                                                                        .style("fill", "lightcoral")
                                                                        .style("stroke", "red");
                                                                d3.selectAll("[idto='" + this.id.split("_")[1] + "']").style("stroke", "#66f").style("stroke-width", "2.5");
                                                                d3.selectAll("[idfrom='" + this.id.split("_")[1] + "']").style("stroke", "#f66").style("stroke-width", "2.5");
                                                                currentIds = [this.id];
                                                            }

                                                        }

                                                    })
                                                    .call(force.drag);
                                            circle.selectAll("node").on("click", function () {
                                                d3.select(this).attr('r', 25)
                                                        .style("fill", "lightcoral")
                                                        .style("stroke", "red");
                                            });
                                            var text = g.selectAll("text")
                                                    .data(force.nodes())
                                                    .enter().append("text")
                                                    .attr("x", 8)
                                                    .attr("y", ".31em")
                                                    .attr("id", function (d) {
                                                        return "text_" + scientistIndex[d.name];
                                                    })
                                                    .text(function (d) {
                                                        //return d.name;
                                                        // d.name is in fact the url     
                                                        var i = scientistIndex[d.name];
                                                        return data[i].name;
                                                    });
                                            if (text_center)
                                                text.text(function (d) {
                                                    var i = scientistIndex[d.name];
                                                    return data[i].name;
                                                })
                                                        .style("text-anchor", "middle");
                                            else
                                                text.attr("dx", function (d) {
                                                    return (size(d.size) || nominal_base_node_size);
                                                })
                                                        .text(function (d) {
                                                            var i = scientistIndex[d.name];
                                                            return '\u2002' + data[i].name;
                                                        });
                                            // Use elliptical arc path segments to doubly-encode directionality.
                                            function tick() {
                                                path.attr("d", linkArc);
                                                circle.attr("transform", transform);
                                                text.attr("transform", transform);
                                            }

                                            var globalXOffset = 0;
                                            var globalYOffset = 0;
                                            function resize() {
                                                var width = window.innerWidth, height = window.innerHeight;
                                                svg.attr("width", width).attr("height", height);
                                                force.size([
                                                    force.size()[0] + (width - w) / zoom.scale() + globalXOffset,
                                                    force.size()[1] + (height - h) / zoom.scale() + globalYOffset]).resume();
                                                w = width;
                                                h = height;
                                            }

                                            // space bar forces force to stop
                                            function keydown() {
                                                if (d3.event.keyCode === 32) {
                                                    force.stop();
                                                }
                                            }

                                            zoom.on("zoom", function () {
                                                var stroke = nominal_stroke;
                                                if (nominal_stroke * zoom.scale() > max_stroke)
                                                    stroke = max_stroke / zoom.scale();
                                                path.style("stroke-width", stroke);
                                                circle.style("stroke-width", stroke);
                                                var base_radius = nominal_base_node_size;
                                                if (nominal_base_node_size * zoom.scale() > max_base_node_size)
                                                    base_radius = max_base_node_size / zoom.scale();
                                                circle.attr("d", d3.svg.symbol()
                                                        .size(function (d) {
                                                            return Math.PI * Math.pow(size(d.size) * base_radius / nominal_base_node_size || base_radius, 2);
                                                        })
                                                        .type(function (d) {
                                                            return d.type;
                                                        }));
                                                //circle.attr("r", function(d) { return (size(d.size)*base_radius/nominal_base_node_size||base_radius); })
                                                if (!text_center)
                                                    text.attr("dx", function (d) {
                                                        return (size(d.size) * base_radius / nominal_base_node_size || base_radius);
                                                    });
                                                var text_size = nominal_text_size;
                                                if (nominal_text_size * zoom.scale() > max_text_size)
                                                    text_size = max_text_size / zoom.scale();
                                                text.style("font-size", text_size + "px");
                                                g.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
                                            });
                                            svg.call(zoom);
                                            resize();
                                            d3.select(window).on("resize", resize).on("keydown", keydown);
                                            function linkArc(d) {
                                                var dx = d.target.x - d.source.x,
                                                        dy = d.target.y - d.source.y,
                                                        dr = Math.sqrt(dx * dx + dy * dy);
                                                return "M" + d.source.x + "," + d.source.y + "A" + dr + "," + dr + " 0 0,1 " + d.target.x + "," + d.target.y;
                                            }

                                            function linkFrom(d) {
                                                return scientistIndex[d.source.name];
                                            }

                                            function linkTo(d) {
                                                return scientistIndex[d.target.name];
                                            }

                                            function transform(d) {
                                                return "translate(" + d.x + "," + d.y + ")";
                                            }

                                        }

                                    });
            </script>
        </div>
    </body>
</html>
